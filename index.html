<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Centro de Pruebas Psicotécnicas de Conducción</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            touch-action: manipulation; /* Allow touches on buttons but prevent other gestures */
        }
        .test-canvas {
            background-color: #f3f4f6; /* Gray 100 */
            border-radius: 0.5rem;
            width: 100%;
            height: 100%;
        }
        .tab-button {
            transition: all 0.3s ease;
        }
        .tab-button.active {
            background-color: #3b82f6; /* Blue 600 */
            color: white;
            font-weight: 600;
        }
        .test-card {
            display: none;
        }
        .test-card.active {
            display: block;
        }
        .ishihara-plate {
            position: relative;
            width: 250px;
            height: 250px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        .ishihara-plate .number {
            font-size: 80px;
            font-weight: bold;
            z-index: 1;
        }
        .ishihara-plate .dot {
            position: absolute;
            border-radius: 50%;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <div class="container mx-auto p-4 md:p-8 max-w-5xl">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800">Centro de Pruebas Psicotécnicas</h1>
            <p class="text-gray-600 mt-2">Simulador para la preparación del examen de conducir.</p>
        </header>

        <!-- Tabs -->
        <div class="flex justify-center border-b-2 border-gray-200 mb-6">
            <button class="tab-button py-2 px-6 text-lg active" onclick="showCategory('psicomotriz')">Psicomotriz</button>
            <button class="tab-button py-2 px-6 text-lg" onclick="showCategory('visual')">Visual</button>
            <button class="tab-button py-2 px-6 text-lg" onclick="showCategory('auditiva')">Auditiva</button>
        </div>

        <main id="test-container">
            <!-- PSICOMOTRIZ CATEGORY -->
            <div id="category-psicomotriz" class="test-card active">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Test: Coordinación Bimanual -->
                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <h3 class="text-xl font-bold mb-2">1. Test de Coordinación Bimanual</h3>
                        <p class="text-gray-600 mb-4">Usa <kbd class="font-mono bg-gray-200 px-2 py-1 rounded">A</kbd>/<kbd class="font-mono bg-gray-200 px-2 py-1 rounded">D</kbd> para la bola azul (izquierda) y <kbd class="font-mono bg-gray-200 px-2 py-1 rounded">←</kbd>/<kbd class="font-mono bg-gray-200 px-2 py-1 rounded">→</kbd> para la roja (derecha). Mantenlas en sus carriles.</p>
                        <div class="aspect-video bg-gray-200 rounded-lg mb-4 relative">
                            <canvas id="bimanualCanvas" class="test-canvas"></canvas>
                        </div>
                        <button id="startBimanual" class="w-full bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600">Empezar</button>
                        <div id="bimanualResults" class="mt-4 text-center font-semibold"></div>
                    </div>

                    <!-- Test: Tiempo de Reacción -->
                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <h3 class="text-xl font-bold mb-2">2. Test de Tiempo de Reacción</h3>
                        <p class="text-gray-600 mb-4">Pulsa <kbd class="font-mono bg-gray-200 px-2 py-1 rounded">ESPACIO</kbd> en cuanto el círculo rojo aparezca. Se harán 5 intentos.</p>
                        <div id="reactionTestArea" class="aspect-video bg-gray-800 rounded-lg mb-4 flex items-center justify-center text-white text-2xl font-bold">
                            Pulsa "Empezar"
                        </div>
                        <button id="startReaction" class="w-full bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600">Empezar</button>
                        <div id="reactionResults" class="mt-4 text-center font-semibold"></div>
                    </div>
                </div>
            </div>

            <!-- VISUAL CATEGORY -->
            <div id="category-visual" class="test-card">
                 <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Test: Agudeza Visual -->
                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <h3 class="text-xl font-bold mb-2">1. Agudeza Visual</h3>
                        <p class="text-gray-600 mb-4">Intenta leer la línea más pequeña que puedas ver y luego pulsa "Revelar" para comprobar.</p>
                        <div id="snellenChart" class="bg-white border-2 rounded-lg p-4 text-center font-mono tracking-widest">
                            <div style="font-size: 2.5rem;">E</div>
                            <div style="font-size: 1.75rem;">F P</div>
                            <div style="font-size: 1.25rem;">T O Z</div>
                            <div style="font-size: 1rem;">L P E D</div>
                            <div id="snellenLine5" style="font-size: 0.75rem;" class="blur-sm">P E C F D</div>
                            <div id="snellenLine6" style="font-size: 0.6rem;" class="blur-md">E D F C Z P</div>
                        </div>
                        <button id="revealSnellen" class="w-full mt-4 bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600">Revelar</button>
                    </div>

                    <!-- Test: Percepción de Colores -->
                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <h3 class="text-xl font-bold mb-2">2. Percepción de Colores</h3>
                        <p class="text-gray-600 mb-4">¿Qué número ves en el círculo? Introduce tu respuesta y comprueba.</p>
                        <div id="ishiharaContainer" class="flex justify-center items-center my-4">
                            <!-- Ishihara plate will be generated here -->
                        </div>
                        <div class="flex gap-2">
                            <input type="text" id="ishiharaInput" class="w-full border-2 rounded-lg p-2 text-center" placeholder="Nº">
                            <button id="checkIshihara" class="bg-blue-500 text-white px-4 rounded-lg hover:bg-blue-600">OK</button>
                        </div>
                        <div id="ishiharaResult" class="mt-2 text-center font-semibold"></div>
                    </div>
                    
                    <!-- Test: Campo Visual -->
                     <div class="bg-white p-6 rounded-xl shadow-md">
                        <h3 class="text-xl font-bold mb-2">3. Campo Visual</h3>
                        <p class="text-gray-600 mb-4">Fija la vista en el punto central. Pulsa <kbd class="font-mono bg-gray-200 px-2 py-1 rounded">ESPACIO</kbd> cada vez que veas aparecer un punto en la periferia.</p>
                        <div class="aspect-square bg-gray-800 rounded-lg mb-4 relative">
                            <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-4 h-4 bg-white rounded-full"></div>
                            <div id="visualFieldStimulus" class="absolute w-3 h-3 bg-yellow-300 rounded-full hidden"></div>
                        </div>
                        <button id="startVisualField" class="w-full bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600">Empezar</button>
                        <div id="visualFieldResult" class="mt-4 text-center font-semibold"></div>
                    </div>
                 </div>
            </div>
            
            <!-- AUDITIVA CATEGORY -->
            <div id="category-auditiva" class="test-card">
                 <div class="flex justify-center">
                    <div class="bg-white p-6 rounded-xl shadow-md w-full max-w-md">
                        <h3 class="text-xl font-bold mb-2">1. Audiometría Básica</h3>
                        <p class="text-gray-600 mb-4">Ponte auriculares. Pulsa "Empezar" y luego pulsa el botón "OÍDO" cada vez que escuches un pitido. Se probarán ambos oídos.</p>
                        <div id="audiometryArea" class="text-center my-8">
                            <p id="audiometryStatus" class="text-2xl font-bold text-gray-700">Listo para empezar</p>
                        </div>
                        <button id="startAudiometry" class="w-full bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600 mb-2">Empezar Prueba</button>
                        <button id="heardToneButton" class="w-full bg-green-500 text-white py-2 rounded-lg hover:bg-green-600 hidden">OÍDO</button>
                        <div id="audiometryResult" class="mt-4 text-center font-semibold"></div>
                    </div>
                 </div>
            </div>
        </main>
    </div>

    <script>
    // --- GLOBAL STATE & UTILS ---
    const App = {
        keys: {},
        activeTest: null,
        audioContext: null,
        audiometrySynth: null,
        errorSynth: null,
        panner: null,
        initAudio() {
            if (this.audioContext) return; // Already initialized
            try {
                if (typeof Tone === 'undefined') {
                    console.error("Tone.js has not loaded yet.");
                    return;
                }
                this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                Tone.setContext(this.audioContext);
                this.panner = new Tone.Panner(0).toDestination();
                // Synth for pure tones in audiometry test, connected to the panner
                this.audiometrySynth = new Tone.Synth().connect(this.panner);
                // Synth for UI feedback sounds (e.g., collision)
                this.errorSynth = new Tone.Synth().toDestination();
            } catch (e) {
                console.error("Could not initialize audio:", e);
                // Disable audio features if it fails
                this.audioContext = null;
            }
        }
    };

    window.addEventListener('keydown', (e) => { App.keys[e.key] = true; });
    window.addEventListener('keyup', (e) => { App.keys[e.key] = false; });
    
    function showCategory(categoryId) {
        document.querySelectorAll('.test-card').forEach(card => card.classList.remove('active'));
        document.getElementById(`category-${categoryId}`).classList.add('active');
        
        document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');

        // Stop any active test when switching tabs
        if (App.activeTest && App.activeTest.stop) {
            App.activeTest.stop();
        }
    }

    // --- 1. PSICOMOTRIZ ---

    // 1.1 Coordinación Bimanual
    const BimanualTest = {
        canvas: document.getElementById('bimanualCanvas'),
        ctx: null,
        resultsEl: document.getElementById('bimanualResults'),
        rafId: null, running: false, duration: 20000, endTime: 0,
        errors: { left: 0, right: 0 },
        speed: 3,
        roadWidth: 50, // Increased from 40 to 50
        
        p1: { x: 0, y: 0, path: [], color: '#3b82f6', isColliding: false },
        p2: { x: 0, y: 0, path: [], color: '#ef4444', isColliding: false },

        init() {
            this.ctx = this.canvas.getContext('2d');
            this.resize();
            window.addEventListener('resize', () => this.resize());
            document.getElementById('startBimanual').addEventListener('click', () => this.start());
        },

        resize() {
            const { width, height } = this.canvas.parentElement.getBoundingClientRect();
            this.canvas.width = width;
            this.canvas.height = height;
            this.p1.y = this.canvas.height - 30;
            this.p2.y = this.canvas.height - 30;
            this.reset();
        },

        reset() {
            this.p1.x = this.canvas.width / 4;
            this.p2.x = this.canvas.width * 3 / 4;
            this.p1.path = this.generatePath(this.canvas.width / 4);
            this.p2.path = this.generatePath(this.canvas.width * 3 / 4);
            this.errors = { left: 0, right: 0 };
            this.resultsEl.textContent = '';
            this.draw();
        },

        generatePath(startX) {
            const path = [];
            let currentX = startX;
            for (let y = this.canvas.height; y >= -10; y -= 5) {
                currentX += (Math.random() - 0.5) * 8;
                currentX = Math.max(this.roadWidth, Math.min(this.canvas.width - this.roadWidth, currentX));
                 // Clamp to prevent paths from overlapping too much
                if (startX < this.canvas.width / 2) {
                    currentX = Math.min(currentX, this.canvas.width / 2 - this.roadWidth);
                } else {
                    currentX = Math.max(currentX, this.canvas.width / 2 + this.roadWidth);
                }
                path.unshift({ y, x: currentX });
            }
            return path;
        },

        start() {
            if (this.running) return;
            App.initAudio();
            App.activeTest = this;
            this.running = true;
            this.reset();
            this.endTime = Date.now() + this.duration;
            this.resultsEl.textContent = '¡En curso!';
            this.loop();
        },
        
        stop() {
            this.running = false;
            cancelAnimationFrame(this.rafId);
            const totalErrors = this.errors.left + this.errors.right;
            this.resultsEl.innerHTML = `Prueba finalizada. <br> Errores Izquierda: ${this.errors.left}, Derecha: ${this.errors.right}. Total: ${totalErrors}`;
            App.activeTest = null;
        },

        update() {
            // Update player positions
            if (App.keys['a'] || App.keys['A']) this.p1.x -= 3;
            if (App.keys['d'] || App.keys['D']) this.p1.x += 3;
            if (App.keys['ArrowLeft']) this.p2.x -= 3;
            if (App.keys['ArrowRight']) this.p2.x += 3;

            // Update paths (scroll down)
            [this.p1.path, this.p2.path].forEach(path => {
                path.forEach(seg => seg.y += this.speed);
                if (path.length > 0 && path[0].y > this.canvas.height) path.shift();
                
                const lastSeg = path[path.length - 1];
                if (lastSeg) {
                    let newX = lastSeg.x + (Math.random() - 0.5) * 8;
                    const startX = path === this.p1.path ? this.canvas.width / 4 : this.canvas.width * 3 / 4;
                    if (startX < this.canvas.width / 2) {
                        newX = Math.min(newX, this.canvas.width / 2 - this.roadWidth);
                    } else {
                        newX = Math.max(newX, this.canvas.width / 2 + this.roadWidth);
                    }
                    newX = Math.max(this.roadWidth, Math.min(this.canvas.width - this.roadWidth, newX));
                    path.push({ y: lastSeg.y - 5, x: newX });
                }
            });

            // Check collisions
            this.checkCollision(this.p1, 'left');
            this.checkCollision(this.p2, 'right');

            if (Date.now() > this.endTime) this.stop();
        },

        checkCollision(player, side) {
            const seg = player.path.find(p => p.y >= player.y);
            if (!seg) return;
            
            const hasCollided = player.x < seg.x - this.roadWidth / 2 || player.x > seg.x + this.roadWidth / 2;

            if (hasCollided && !player.isColliding) {
                player.isColliding = true;
                this.errors[side]++;
                if(App.errorSynth) App.errorSynth.triggerAttackRelease("C5", "8n");
            } else if (!hasCollided) {
                player.isColliding = false;
            }
        },

        draw() {
            this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
            this.drawPath(this.p1.path, this.p1.color);
            this.drawPath(this.p2.path, this.p2.color);
            this.drawPlayer(this.p1);
            this.drawPlayer(this.p2);
        },

        drawPath(path, color) {
            this.ctx.fillStyle = `${color}33`; // semi-transparent
            this.ctx.beginPath();
            if(path.length === 0) return;
            this.ctx.moveTo(path[0].x - this.roadWidth / 2, path[0].y);
            for(let i=1; i<path.length; i++) this.ctx.lineTo(path[i].x - this.roadWidth/2, path[i].y);
            for(let i=path.length-1; i>=0; i--) this.ctx.lineTo(path[i].x + this.roadWidth/2, path[i].y);
            this.ctx.closePath();
            this.ctx.fill();
        },

        drawPlayer(player) {
            this.ctx.fillStyle = player.color;
            this.ctx.beginPath();
            this.ctx.arc(player.x, player.y, 10, 0, Math.PI * 2);
            this.ctx.fill();
        },

        loop() {
            if (!this.running) return;
            this.update();
            this.draw();
            this.rafId = requestAnimationFrame(() => this.loop());
        }
    };

    // 1.2 Tiempo de Reacción
    const ReactionTest = {
        area: document.getElementById('reactionTestArea'),
        resultsEl: document.getElementById('reactionResults'),
        running: false,
        waitingForClick: false,
        startTime: 0,
        results: [],
        maxTests: 5,
        timeoutId: null,

        init() {
            document.getElementById('startReaction').addEventListener('click', () => this.start());
        },

        start() {
            if (this.running) return;
            App.activeTest = this;
            this.running = true;
            this.results = [];
            this.resultsEl.textContent = '';
            this.area.style.backgroundColor = '#1f2937'; // Gray 800
            window.addEventListener('keydown', this.handleKeyPress);
            this.nextTest();
        },
        
        stop() {
            this.running = false;
            this.waitingForClick = false;
            clearTimeout(this.timeoutId);
            window.removeEventListener('keydown', this.handleKeyPress);
            if (this.results.length > 0) {
                const avg = this.results.reduce((a, b) => a + b, 0) / this.results.length;
                this.resultsEl.textContent = `Prueba finalizada. Tiempo medio: ${avg.toFixed(0)} ms.`;
            } else {
                 this.resultsEl.textContent = `Prueba cancelada.`;
            }
            this.area.textContent = 'Pulsa "Empezar"';
            App.activeTest = null;
        },

        nextTest() {
            if (this.results.length >= this.maxTests) {
                this.stop();
                return;
            }
            this.waitingForClick = false;
            this.area.style.backgroundColor = '#1f2937'; // Gray 800
            this.area.textContent = `Prueba ${this.results.length + 1} de ${this.maxTests}. Espera...`;
            const delay = Math.random() * 4000 + 1000; // 1-5 seconds
            this.timeoutId = setTimeout(() => {
                this.area.style.backgroundColor = '#ef4444'; // Red 500
                this.area.textContent = '¡PULSA ESPACIO!';
                this.waitingForClick = true;
                this.startTime = performance.now();
            }, delay);
        },

        handleKeyPress: (e) => {
            if (e.key !== ' ') return;
            e.preventDefault();
            const self = ReactionTest; // 'this' is window here
            if (!self.running) return;

            if (self.waitingForClick) {
                const reactionTime = performance.now() - self.startTime;
                self.results.push(reactionTime);
                self.resultsEl.textContent = `Intento ${self.results.length}: ${reactionTime.toFixed(0)} ms`;
                self.waitingForClick = false;
                self.nextTest();
            } else {
                // Clicked too early
                clearTimeout(self.timeoutId);
                self.area.textContent = '¡Demasiado pronto!';
                self.waitingForClick = false;
                setTimeout(() => self.nextTest(), 1500);
            }
        }
    };
    
    // --- 2. VISUAL ---
    
    // 2.1 Agudeza Visual
    const SnellenTest = {
        init() {
            document.getElementById('revealSnellen').addEventListener('click', () => {
                document.getElementById('snellenLine5').classList.remove('blur-sm');
                document.getElementById('snellenLine6').classList.remove('blur-md');
            });
        }
    };

    // 2.2 Percepción de Colores (Ishihara)
    const IshiharaTest = {
        container: document.getElementById('ishiharaContainer'),
        input: document.getElementById('ishiharaInput'),
        resultEl: document.getElementById('ishiharaResult'),
        currentPlate: null,
        plates: [
            { number: '12', numColor: '#f97316', bgColors: ['#4ade80', '#22c55e', '#16a34a'] },
            { number: '8', numColor: '#f43f5e', bgColors: ['#a3a3a3', '#737373', '#525252'] },
            { number: '29', numColor: '#3b82f6', bgColors: ['#f472b6', '#ec4899', '#db2777'] },
            { number: '5', numColor: '#84cc16', bgColors: ['#f97316', '#ea580c', '#c2410c'] },
            { number: '74', numColor: '#eab308', bgColors: ['#a855f7', '#9333ea', '#7e22ce'] },
        ],

        init() {
            this.generatePlate();
            document.getElementById('checkIshihara').addEventListener('click', () => this.check());
        },

        generatePlate() {
            this.container.innerHTML = '';
            this.resultEl.textContent = '';
            this.input.value = '';
            this.currentPlate = this.plates[Math.floor(Math.random() * this.plates.length)];
            
            const plateEl = document.createElement('div');
            plateEl.className = 'ishihara-plate';
            
            // Generate background dots
            for (let i = 0; i < 250; i++) {
                const dot = document.createElement('div');
                dot.className = 'dot';
                const size = Math.random() * 20 + 5;
                dot.style.width = `${size}px`;
                dot.style.height = `${size}px`;
                dot.style.top = `${Math.random() * 100}%`;
                dot.style.left = `${Math.random() * 100}%`;
                dot.style.transform = `translate(-50%, -50%)`;
                dot.style.backgroundColor = this.currentPlate.bgColors[Math.floor(Math.random() * this.currentPlate.bgColors.length)];
                plateEl.appendChild(dot);
            }
            
            const numberEl = document.createElement('span');
            numberEl.className = 'number';
            numberEl.textContent = this.currentPlate.number;
            numberEl.style.color = this.currentPlate.numColor;
            plateEl.appendChild(numberEl);

            this.container.appendChild(plateEl);
        },

        check() {
            if (this.input.value === this.currentPlate.number) {
                this.resultEl.textContent = '¡Correcto!';
                this.resultEl.style.color = 'green';
            } else {
                this.resultEl.textContent = `Incorrecto. El número era ${this.currentPlate.number}.`;
                this.resultEl.style.color = 'red';
            }
            setTimeout(() => this.generatePlate(), 2000);
        }
    };

    // 2.3 Campo Visual
    const VisualFieldTest = {
        stimulus: document.getElementById('visualFieldStimulus'),
        resultEl: document.getElementById('visualFieldResult'),
        running: false,
        timeoutId: null,
        detected: 0,
        shown: 0,
        maxStimuli: 10,
        stimulusVisible: false,
        
        init() {
            document.getElementById('startVisualField').addEventListener('click', () => this.start());
        },

        start() {
            if (this.running) return;
            App.activeTest = this;
            this.running = true;
            this.detected = 0;
            this.shown = 0;
            this.resultEl.textContent = 'Prueba en curso...';
            window.addEventListener('keydown', this.handleKeyPress);
            this.nextStimulus();
        },

        stop() {
            this.running = false;
            clearTimeout(this.timeoutId);
            window.removeEventListener('keydown', this.handleKeyPress);
            this.resultEl.textContent = `Prueba finalizada. Detectados: ${this.detected} de ${this.shown}.`;
            App.activeTest = null;
        },

        nextStimulus() {
            if (this.shown >= this.maxStimuli) {
                this.stop();
                return;
            }
            this.stimulusVisible = false;
            this.stimulus.classList.add('hidden');
            const delay = Math.random() * 3000 + 1000;
            this.timeoutId = setTimeout(() => {
                this.shown++;
                const angle = Math.random() * 2 * Math.PI;
                const radius = Math.random() * 40 + 50; // pixels from center
                this.stimulus.style.top = `calc(50% - ${this.stimulus.offsetHeight/2}px + ${Math.sin(angle) * radius}px)`;
                this.stimulus.style.left = `calc(50% - ${this.stimulus.offsetWidth/2}px + ${Math.cos(angle) * radius}px)`;
                this.stimulus.classList.remove('hidden');
                this.stimulusVisible = true;
                
                // Hide it after a short time and schedule the next one
                setTimeout(() => {
                     this.stimulus.classList.add('hidden');
                     this.stimulusVisible = false;
                     this.nextStimulus();
                }, 800);

            }, delay);
        },
        
        handleKeyPress: (e) => {
            if (e.key !== ' ') return;
            e.preventDefault();
            const self = VisualFieldTest;
            if (self.stimulusVisible) {
                self.detected++;
                self.stimulusVisible = false; // prevent multiple detections for the same stimulus
                self.stimulus.classList.add('hidden');
            }
        }
    };
    
    // --- 3. AUDITIVA ---
    const AudiometryTest = {
        statusEl: document.getElementById('audiometryStatus'),
        resultEl: document.getElementById('audiometryResult'),
        startButton: document.getElementById('startAudiometry'),
        heardButton: document.getElementById('heardToneButton'),
        running: false,
        timeoutId: null,
        frequencies: [500, 1000, 2000, 4000], // Hz
        sides: [-1, 1], // Left, Right
        currentTest: 0,
        tests: [],
        results: [],
        heard: false,

        init() {
            this.startButton.addEventListener('click', () => this.start());
            this.heardButton.addEventListener('click', () => { this.heard = true; });
        },

        start() {
            if (this.running) return;
            App.initAudio();
            if (!App.audioContext) {
                this.statusEl.textContent = 'Error al iniciar el audio.';
                return;
            }
            App.activeTest = this;
            this.running = true;
            this.results = [];
            this.currentTest = 0;
            this.resultEl.textContent = '';
            this.startButton.classList.add('hidden');
            this.heardButton.classList.remove('hidden');
            
            // Create test sequence
            this.tests = [];
            for (const freq of this.frequencies) {
                for (const side of this.sides) {
                    this.tests.push({ freq, side });
                }
            }
            // Shuffle tests
            this.tests.sort(() => Math.random() - 0.5);
            
            this.nextTest();
        },

        stop() {
            this.running = false;
            clearTimeout(this.timeoutId);
            this.heardButton.classList.add('hidden');
            this.startButton.classList.remove('hidden');
            this.statusEl.textContent = 'Prueba finalizada';
            const detectedCount = this.results.filter(r => r.detected).length;
            this.resultEl.textContent = `Detectados ${detectedCount} de ${this.tests.length} tonos.`;
            App.activeTest = null;
        },

        nextTest() {
            if (this.currentTest >= this.tests.length) {
                this.stop();
                return;
            }

            const test = this.tests[this.currentTest];
            const sideText = test.side === -1 ? 'izquierdo' : 'derecho';
            this.statusEl.textContent = `Prueba ${this.currentTest + 1}/${this.tests.length}. Escuchando oído ${sideText}...`;
            this.heard = false;

            const delay = Math.random() * 4000 + 2000; // 2-6 sec delay
            this.timeoutId = setTimeout(() => {
                App.panner.pan.value = test.side;
                if(App.audiometrySynth) App.audiometrySynth.triggerAttackRelease(test.freq, '0.5s');
                
                // Check if heard after tone finishes
                setTimeout(() => {
                    this.results.push({ ...test, detected: this.heard });
                    this.currentTest++;
                    this.nextTest();
                }, 1000);

            }, delay);
        }
    };

    // --- INITIALIZE ALL TESTS ---
    window.addEventListener('DOMContentLoaded', () => {
        BimanualTest.init();
        ReactionTest.init();
        SnellenTest.init();
        IshiharaTest.init();
        VisualFieldTest.init();
        AudiometryTest.init();
    });

    </script>
</body>
</html>
